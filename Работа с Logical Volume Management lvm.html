<!DOCTYPE html><html><head><meta charset="utf-8"><title>Работа с Logical Volume Management lvm.md</title><style></style></head><body id="preview">
<h1 class="code-line" data-line-start=0 data-line-end=1><a id="__Logical_Volume_Management_lvm_0"></a>Работа с Logical Volume Management lvm</h1>
<p class="has-line-data" data-line-start="1" data-line-end="2">В данной работе представлены примеры работы с LVM</p>
<h2 class="code-line" data-line-start=3 data-line-end=4><a id="_______8G_3"></a>Уменьшить том под / (корневой каталог) до 8G</h2>
<p class="has-line-data" data-line-start="5" data-line-end="6">Подготовим временный том для / раздела.</p>
<p class="has-line-data" data-line-start="7" data-line-end="10">Создаем раздел pv:<br>
<code># pvcreate /dev/sdb</code><br>
<em>Physical volume “/dev/sdb” successfully created.</em></p>
<p class="has-line-data" data-line-start="11" data-line-end="14">Создаем раздел vm:<br>
<code># vgcreate vg_root /dev/sdb</code><br>
<em>Volume group “vg_root” successfully created</em></p>
<p class="has-line-data" data-line-start="15" data-line-end="18">Создаем раздел lv:<br>
<code># lvcreate -n lv_root -l +100%FREE /dev/vg_root Logical volume</code><br>
<em>“lv_root” created.</em></p>
<p class="has-line-data" data-line-start="19" data-line-end="22">Создадим на нем файловую систему и смонтируем его, чтобы перенести туда данные:<br>
<code># mkfs.xfs /dev/vg_root/lv_root</code><br>
<code># mount /dev/vg_root/lv_root /mnt</code></p>
<p class="has-line-data" data-line-start="23" data-line-end="25">Этой командой скопируем все данные с / раздела в /mnt:<br>
<code>xfsdump -J - /dev/VolGroup00/LogVol00 | xfsrestore -J - /mnt</code></p>
<p class="has-line-data" data-line-start="26" data-line-end="27">Переконфигурируем grub для того, чтобы при старте перейти в новый /</p>
<p class="has-line-data" data-line-start="28" data-line-end="30">Создадим все основные каталоги:<br>
<code># for i in /proc/ /sys/ /dev/ /run/ /boot/; do mount --bind $i /mnt/$i; done</code></p>
<p class="has-line-data" data-line-start="31" data-line-end="33">Создадим имитацию текущего root -&gt; сделаем в него chroot и обновим grub:<br>
<code># chroot /mnt/</code></p>
<p class="has-line-data" data-line-start="34" data-line-end="36">Обновим образ initrd.<br>
<code># cd /boot ; for i in</code>ls initramfs-*img<code>; do dracut -v $i</code>echo $i|sed “s/initramfs-//g; s/.img//g”<code>--force; done</code></p>
<p class="has-line-data" data-line-start="37" data-line-end="38">В файле <em>/boot/grub2/grub.cfg</em> нужно заменить предыдущий том lvm на вновь созданный: <em>rd.lvm.lv=VolGroup00/LogVol00</em> =&gt; <em>rd.lvm.lv=vg_root lv_root</em></p>
<p class="has-line-data" data-line-start="39" data-line-end="40">Перезагружаемся успешно с новым рут томом. Убедиться в этом можно посмотрев вывод lsblk:</p>
<p class="has-line-data" data-line-start="41" data-line-end="46">Изменяем размер старой VG и возвращаем на него рут.<br>
Для этого удаляем старый LV размеров в 40G:<br>
<code># lvremove /dev/VolGroup00/LogVol00</code><br>
<em>Do you really want to remove active logical volume VolGroup00/LogVol00? [y/n]: y<br>
Logical volume “LogVol00” successfully removed</em></p>
<p class="has-line-data" data-line-start="47" data-line-end="50">Создаем новый на 8G:<br>
<code># lvcreate -n VolGroup00/LogVol00 -L 8G /dev/VolGroup00</code><br>
<em>WARNING: xfs signature detected on /dev/VolGroup00/LogVol00 at offset 0. Wipe it? [y/n]: y Wiping xfs signature on /dev/VolGroup00 LogVol00. Logical volume “LogVol00” created.</em></p>
<p class="has-line-data" data-line-start="51" data-line-end="54">Создадим на нем файловую систему и смонтируем его, чтобы перенести туда данные:<br>
<code># mkfs.xfs /dev/VolGroup00/LogVol00</code><br>
<code># mount /dev/VolGroup00/LogVol00 /mnt</code></p>
<p class="has-line-data" data-line-start="55" data-line-end="57">Обратно скопируем все данные с / раздела в /mnt:<br>
<code># xfsdump -J - /dev/vg_root/lv_root | xfsrestore -J - /mnt</code></p>
<p class="has-line-data" data-line-start="58" data-line-end="60">Так же как в первый раз переконфигурируем grub, за исключением правки /etc/grub2/grub.cfg:<br>
<code># for i in /proc/ /sys/ /dev/ /run/ /boot/; do mount --bind $i /mnt/$i; done</code></p>
<p class="has-line-data" data-line-start="61" data-line-end="62"><code># chroot /mnt/</code></p>
<p class="has-line-data" data-line-start="63" data-line-end="64"><code># grub2-mkconfig -o /boot/grub2/grub.cfg</code></p>
<p class="has-line-data" data-line-start="65" data-line-end="66"><code># cd /boot ; for i in</code>ls initramfs-*img<code>; do dracut -v $i</code>echo $i|sed “s/initramfs-//g; s/.img//g”<code>--force; done</code></p>
<p class="has-line-data" data-line-start="67" data-line-end="75">После чего можно успешно перезагружаться в новый / и удалять временную Volume Group:<br>
<code># lvremove /dev/vg_root/lv_root</code><br>
<em>Do you really want to remove active logical volume vg_root/lv_root? [y/n]: y<br>
Logical volume “lv_root” successfully removed</em><br>
<code># vgremove /dev/vg_root</code><br>
<em>Volume group “vg_root” successfully removed</em><br>
<code># pvremove /dev/sdb</code><br>
<em>Labels on physical volume “/dev/sdb” successfully wiped.</em></p>
<h2 class="code-line" data-line-start=76 data-line-end=77><a id="_lvm_____var_76"></a>Выделить lvm том в зеркале под /var</h2>
<p class="has-line-data" data-line-start="78" data-line-end="82">На дисках sdc и sdd создаем lvm том с зеркалом на 750 Мб:<br>
<code># pvcreate /dev/sdc /dev/sdd</code><br>
<em>Physical volume “/dev/sdc” successfully created.<br>
Physical volume “/dev/sdd” successfully created.</em></p>
<p class="has-line-data" data-line-start="83" data-line-end="85"><code># vgcreate vg_var /dev/sdc /dev/sdd</code><br>
<em>Volume group “vg_var” successfully created</em></p>
<p class="has-line-data" data-line-start="86" data-line-end="89"><code># lvcreate -L 750M -m1 -n lv_var vg_var</code><br>
<em>Rounding up size to full physical extent 752.00 MiB<br>
Logical volume “lv_var” created.</em></p>
<p class="has-line-data" data-line-start="90" data-line-end="92">Создаем на нем ФС:<br>
<code># mkfs.ext4 /dev/vg_var/lv_var</code></p>
<p class="has-line-data" data-line-start="93" data-line-end="96">Перемещаем туда /var:<br>
<code># mount /dev/vg_var/lv_var /mnt</code><br>
<code># cp -aR /var/* /mnt/</code></p>
<p class="has-line-data" data-line-start="97" data-line-end="99">На всякий случай сохраняем содержимое старого var:<br>
<code># mkdir /tmp/oldvar &amp;&amp; mv /var/* /tmp/oldvar</code></p>
<p class="has-line-data" data-line-start="100" data-line-end="103">Монтируем новый var в каталог /var:<br>
<code># umount /mnt</code><br>
<code># mount /dev/vg_var/lv_var /var</code></p>
<p class="has-line-data" data-line-start="104" data-line-end="106">Правим fstab для автоматического монтирования /var:<br>
<em>echo &quot;<code>blkid | grep var: | awk '{print $2}'</code> /var ext4 defaults 0 0&quot; &gt;&gt; /etc/fstab</em></p>
<p class="has-line-data" data-line-start="107" data-line-end="108">Перезагружаемся и командой lsblk проверяем.</p>
<h2 class="code-line" data-line-start=109 data-line-end=110><a id="_lvm__gjl_home_109"></a>Выделить lvm том gjl /home</h2>
<p class="has-line-data" data-line-start="111" data-line-end="112"><code># pvcreate /dev/sdb</code></p>
<p class="has-line-data" data-line-start="113" data-line-end="114"><code># vgcreate vg_home /dev/sdb</code></p>
<p class="has-line-data" data-line-start="115" data-line-end="116"><code># lvcreate -n lv_home -L 5G /dev/vg_home</code></p>
<p class="has-line-data" data-line-start="117" data-line-end="118"><code># mkfs.xfs /dev/vg_home/lv_home</code></p>
<p class="has-line-data" data-line-start="119" data-line-end="120"><code># mount /dev/vg_home/lv_home /mnt/</code></p>
<p class="has-line-data" data-line-start="121" data-line-end="123">cp -aR /home/* /mnt/<br>
<code># rm -rf /home/*</code></p>
<p class="has-line-data" data-line-start="124" data-line-end="126"><code># umount /mnt</code><br>
<code># mount /dev/vg_home/lv_home /home/</code></p>
<p class="has-line-data" data-line-start="127" data-line-end="128"><em>echo &quot;<code>blkid | grep lv_home | awk '{print $2}'</code> /home xfs defaults 0 0&quot; &gt;&gt; /etc/fstab</em></p>
</body></html>